name: AdBloX MESH Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  refactor-sign-release:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run Refactor
        run: |
          # Vi hittar IPA-filen dynamiskt så namnet inte spelar roll
          IPA_FILE=$(ls *.ipa | head -n 1)
          python3 refactor.py --input "$IPA_FILE" --output "AdBloX-MESH-Branded.ipa"

      - name: Unpack and Hard Reset
        run: |
          mkdir -p build
          unzip -q "AdBloX-MESH-Branded.ipa" -d build
          # Rensar bort alla gamla signaturer så KravaSigner inte blir förvirrad
          find build/Payload -name "_CodeSignature" -exec rm -rf {} +

      - name: Ad-hoc Sign Nested
        run: |
          APP_PATH="build/Payload/AdBloX.app"
          # Signera VPN-motorn (Extension) först
          if [ -d "$APP_PATH/PlugIns/AdBloXNetworkExtension.appex" ]; then
            /usr/bin/codesign --force --deep --sign - "$APP_PATH/PlugIns/AdBloXNetworkExtension.appex"
          fi
          # Signera huvudappen
          /usr/bin/codesign --force --deep --sign - "$APP_PATH"

      - name: Rebuild Final IPA
        run: |
          cd build
          zip -qry "../AdBloX-MESH-Electric-Final.ipa" Payload/
          
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: AdBloX-MESH-Electric-Final
          path: AdBloX-MESH-Electric-Final.ipa
