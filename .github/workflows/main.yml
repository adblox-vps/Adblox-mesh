name: Build AdBloX MESH Branded IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  refactor-sign-release:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run Refactor Script
        run: |
          # Detta skript fixar färger och Bundle IDs så de matchar
          python3 refactor.py \
            --input "AdBloX-MESH-v1.8.2 (3).ipa" \
            --output "AdBloX-MESH-Branded.ipa"

      - name: Unpack and Hard Reset Signatures
        run: |
          mkdir -p build
          unzip -q "AdBloX-MESH-Branded.ipa" -d build
          # Tar bort gamla signaturer som krockar med KravaSigner
          find build/Payload -name "_CodeSignature" -exec rm -rf {} +

      - name: Ad-hoc Sign (Nested)
        shell: bash
        run: |
          TARGET_APP="build/Payload/AdBloX.app"
          EXTENSION="$TARGET_APP/PlugIns/AdBloXNetworkExtension.appex"
          
          # Signera inifrån och ut - ett måste för VPN-appar
          if [ -d "$EXTENSION" ]; then
            /usr/bin/codesign --force --deep --sign - "$EXTENSION"
          fi
          /usr/bin/codesign --force --deep --sign - "$TARGET_APP"

      - name: Rebuild IPA
        run: |
          cd build
          zip -qry "../AdBloX-MESH-Electric-Final.ipa" Payload/
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AdBloX-MESH-Electric-Final
          path: AdBloX-MESH-Electric-Final.ipa

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: "v1.8.2-blue-${{ github.run_number }}"
          name: "AdBloX MESH Electric Final"
          files: "AdBloX-MESH-Electric-Final.ipa"
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
